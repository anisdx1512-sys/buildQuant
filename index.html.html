<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BuildQuant — DQE</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6fa}
.topbar{background:#004AAD;color:#fff;padding:12px 20px;font-weight:700}
.container{padding:20px;max-width:1200px;margin:auto}
input,select{padding:6px;border:1px solid #ccc;border-radius:4px}
button{padding:6px 12px;border:none;border-radius:4px;cursor:pointer}
.btn-blue{background:#004AAD;color:#fff}
.btn-red{background:#c62828;color:#fff}
.table-wrap{overflow:auto;background:#fff;border:1px solid #ddd;margin-top:15px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#004AAD;color:#fff}
.right{text-align:right}
.totals{margin-top:20px;width:300px;margin-left:auto;background:#fff;border:1px solid #ddd}
.totals div{padding:8px;border-bottom:1px solid #ddd}
.totals .final{background:#004AAD;color:#fff;font-weight:700;font-size:14px}
</style>
</head>

<body>

<div class="topbar">BuildQuant — Devis Quantitatif Estimatif</div>

<div class="container">

<div>
Projet : <input id="proj-name">
Client : <input id="proj-client">
Date : <input type="date" id="proj-date">
</div>

<div style="margin-top:10px">
<button class="btn-blue" onclick="addRow()">+ Ajouter Poste</button>
<button onclick="downloadPDF()">Exporter PDF</button>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>N°</th>
<th>Désignation</th>
<th>Unité</th>
<th>Qté</th>
<th>PU</th>
<th>Total</th>
<th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="totals">
<div>Total HT : <span id="ht">0,00 DZD</span></div>
<div>TVA 
<select id="tva" onchange="recalc()">
<option value="0">0%</option>
<option value="9">9%</option>
<option value="19" selected>19%</option>
</select>
: <span id="tva-val">0,00 DZD</span></div>
<div class="final">Total TTC : <span id="ttc">0,00 DZD</span></div>
</div>

</div>

<script>
let rows=[];
let id=0;

function addRow(){
id++;
rows.push({id,desig:"",unit:"m²",qty:0,pu:0});
render();
}

function deleteRow(i){
rows=rows.filter(r=>r.id!==i);
render();
}

function render(){
let body=document.getElementById("tbody");
body.innerHTML="";
rows.forEach((r,index)=>{
body.innerHTML+=`
<tr>
<td>${index+1}</td>
<td><input onchange="update(${r.id},'desig',this.value)"></td>
<td>
<select onchange="update(${r.id},'unit',this.value)">
<option>m²</option><option>m³</option>
<option>ml</option><option>U</option>
</select>
</td>
<td><input type="number" onchange="update(${r.id},'qty',this.value)"></td>
<td><input type="number" onchange="update(${r.id},'pu',this.value)"></td>
<td class="right">${fmt(calc(r))}</td>
<td><button class="btn-red" onclick="deleteRow(${r.id})">X</button></td>
</tr>
`;
});
recalc();
}

function update(i,field,val){
let r=rows.find(x=>x.id===i);
r[field]=parseFloat(val)||val;
render();
}

function calc(r){
return (parseFloat(r.qty)||0)*(parseFloat(r.pu)||0);
}

function recalc(){
let ht=rows.reduce((s,r)=>s+calc(r),0);
let rate=parseFloat(document.getElementById("tva").value)/100;
let tva=ht*rate;
let ttc=ht+tva;
document.getElementById("ht").innerText=fmt(ht)+" DZD";
document.getElementById("tva-val").innerText=fmt(tva)+" DZD";
document.getElementById("ttc").innerText=fmt(ttc)+" DZD";
}

function fmt(n){
return new Intl.NumberFormat("fr-DZ",{minimumFractionDigits:2}).format(n||0);
}

async function downloadPDF(){

if(rows.length===0){alert("Ajoutez un poste");return;}

let ht=rows.reduce((s,r)=>s+calc(r),0);
let rate=parseFloat(document.getElementById("tva").value)/100;
let tva=ht*rate;
let ttc=ht+tva;

let content=document.createElement("div");
content.innerHTML=`
<div style="font-family:Arial;width:794px;padding:20px">
<div style="background:#004AAD;color:#fff;padding:12px">
<div style="font-size:18px;font-weight:700">BuildQuant</div>
<div style="font-size:10px">DEVIS QUANTITATIF ESTIMATIF</div>
</div>

<div style="margin-top:10px">
<strong>Projet:</strong> ${document.getElementById("proj-name").value}<br>
<strong>Client:</strong> ${document.getElementById("proj-client").value}<br>
<strong>Date:</strong> ${document.getElementById("proj-date").value}
</div>

<table style="width:100%;border-collapse:collapse;margin-top:15px;font-size:10px">
<thead style="background:#004AAD;color:#fff;display:table-header-group">
<tr>
<th style="border:1px solid #ddd">N°</th>
<th style="border:1px solid #ddd">Désignation</th>
<th style="border:1px solid #ddd">Unité</th>
<th style="border:1px solid #ddd">Qté</th>
<th style="border:1px solid #ddd">PU</th>
<th style="border:1px solid #ddd">Total</th>
</tr>
</thead>
<tbody>
${rows.map((r,i)=>`
<tr style="page-break-inside:avoid">
<td style="border:1px solid #ddd">${i+1}</td>
<td style="border:1px solid #ddd">${r.desig||""}</td>
<td style="border:1px solid #ddd">${r.unit}</td>
<td style="border:1px solid #ddd;text-align:right">${fmt(r.qty)}</td>
<td style="border:1px solid #ddd;text-align:right">${fmt(r.pu)}</td>
<td style="border:1px solid #ddd;text-align:right;font-weight:700;color:#004AAD">${fmt(calc(r))}</td>
</tr>
`).join("")}
</tbody>
</table>

<div style="margin-top:20px;width:300px;margin-left:auto;border:1px solid #ddd">
<div style="padding:6px;border-bottom:1px solid #ddd">Total HT: ${fmt(ht)} DZD</div>
<div style="padding:6px;border-bottom:1px solid #ddd">TVA: ${fmt(tva)} DZD</div>
<div style="padding:8px;background:#004AAD;color:#fff;font-weight:700">Total TTC: ${fmt(ttc)} DZD</div>
</div>

</div>
`;

await html2pdf().set({
margin:[10,10,15,10],
filename:"BuildQuant_DQE.pdf",
image:{type:"jpeg",quality:0.98},
html2canvas:{scale:2},
jsPDF:{unit:"mm",format:"a4"},
pagebreak:{mode:["avoid-all","css","legacy"]}
}).from(content).toPdf().get("pdf").then(function(pdf){
let pages=pdf.internal.getNumberOfPages();
for(let i=1;i<=pages;i++){
pdf.setPage(i);
pdf.setFontSize(8);
pdf.text(`Page ${i} / ${pages}`,200,290,{align:"right"});
}
}).save();
}
</script>

</body>
</html>
