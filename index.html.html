<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BuildQuant ‚Äî M√©treur Num√©rique BTPH</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap');
  :root { --blue: #004AAD; --blue-dim: #e8f0fd; --slate: #475569; --border: #e2e8f0; --radius: 12px; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: #f8fafc; color: #1e293b; padding-bottom: 120px; }
  
  .topnav { background: var(--blue); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .main { max-width: 1200px; margin: 0 auto; padding: 20px; }
  
  .card { background: white; border-radius: var(--radius); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
  
  /* ‚îÄ‚îÄ QUICK ACTIONS ‚îÄ‚îÄ */
  .quick-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: thin; }
  .quick-chip { flex-shrink: 0; white-space: nowrap; padding: 8px 16px; background: white; border: 1px solid var(--border); border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; }
  .quick-chip:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-dim); }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; min-width: 800px; background: white; }
  th { background: #f8fafc; padding: 12px; text-align: left; font-size: 11px; text-transform: uppercase; color: var(--slate); border-bottom: 2px solid var(--border); }
  td { padding: 12px; border-bottom: 1px solid var(--border); }
  input, select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; width: 100%; font-size: 13px; }
  
  /* ‚îÄ‚îÄ TOTALS PANEL (MOBILE OPTIMIZED) ‚îÄ‚îÄ */
  .totals-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 1160px; background: white; padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 900; }
  .totals-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 15px; }
  .total-block { padding: 12px; background: #fafbfc; border-radius: 8px; border: 1px solid var(--border); }
  .total-block.accent { background: var(--blue); color: white; border: none; }
  .total-label { font-size: 10px; text-transform: uppercase; font-weight: 700; opacity: 0.8; margin-bottom: 4px; }
  .total-value { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 700; }
  .controls { display: flex; justify-content: space-between; align-items: center; gap: 15px; }
  .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
  .btn-pdf { background: #dc2626; color: white; }
  .btn-outline { background: white; border: 1px solid var(--border); color: var(--slate); }

  @media (max-width: 600px) {
    body { padding-bottom: 180px; }
    .totals-grid { grid-template-columns: 1fr 1fr; }
    .total-block.accent { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; }
    .total-value { font-size: 14px; }
    .controls { flex-direction: column; align-items: stretch; }
    .btn-group { display: flex; gap: 8px; }
    .btn-group .btn { flex: 1; justify-content: center; }
  }
</style>
</head>
<body>

<nav class="topnav">
  <div style="font-weight: 800; font-size: 18px;">üèó BuildQuant</div>
  <div id="save-status" style="font-size: 11px; opacity: 0.7;">En attente...</div>
</nav>

<div class="main">
  <div class="card">
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
      <div>
        <label style="font-size: 11px; font-weight: 700; color: var(--slate);">INTITUL√â DU PROJET</label>
        <input type="text" id="proj-name" placeholder="Ex: VRD Cit√© 100 Logements" oninput="saveProject()">
      </div>
      <div>
        <label style="font-size: 11px; font-weight: 700; color: var(--slate);">CLIENT</label>
        <input type="text" id="proj-client" placeholder="Ex: DUC Tizi Ouzou" oninput="saveProject()">
      </div>
    </div>
  </div>

  <div class="card">
    <div style="font-size: 11px; font-weight: 700; color: var(--slate); margin-bottom: 10px;">‚ö° AJOUT RAPIDE (VRD & BTPH)</div>
    <div class="quick-scroll">
      <button class="quick-chip" onclick="addQuick('terrassement')">‚õè Terrassement</button>
      <button class="quick-chip" onclick="addQuick('fondations')">ü™® Fondations</button>
      <button class="quick-chip" onclick="addQuick('assainissement')">üåä Assainissement</button>
      <button class="quick-chip" onclick="addQuick('aep')">üö∞ AEP</button>
      <button class="quick-chip" onclick="addQuick('enrobe')">üõ£ Enrob√©</button>
      <button class="quick-chip" onclick="addQuick('bordure')">‚Üî Bordures</button>
    </div>
  </div>

  <div class="card" style="padding: 0;">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width: 50%;">D√©signation</th>
            <th>Unit√©</th>
            <th>Qt√©</th>
            <th>P.U (DZD)</th>
            <th style="text-align: right;">Total HT</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <div style="padding: 15px; text-align: center;">
      <button class="btn btn-outline" style="margin: 0 auto;" onclick="addRow()">+ Ajouter un poste manuel</button>
    </div>
  </div>
</div>

<div class="totals-panel">
  <div class="totals-grid">
    <div class="total-block">
      <div class="total-label">Total HT</div>
      <div class="total-value" id="total-ht">0,00 DZD</div>
    </div>
    <div class="total-block">
      <div class="total-label">TVA (<span id="tva-label">19</span>%)</div>
      <div class="total-value" id="total-tva">0,00 DZD</div>
    </div>
    <div class="total-block accent">
      <div class="total-label">TOTAL TTC</div>
      <div class="total-value" id="total-ttc">0,00 DZD</div>
    </div>
  </div>
  <div class="controls">
    <select id="tva-select" style="width: auto; font-weight: 700;" onchange="recalc()">
      <option value="19">TVA 19% (Standard)</option>
      <option value="9">TVA 9% (R√©duite)</option>
      <option value="0">Exon√©r√© (0%)</option>
    </select>
    <div class="btn-group">
      <button class="btn btn-outline" onclick="newProject()">üìÑ Nouveau</button>
      <button class="btn btn-pdf" id="btn-pdf" onclick="downloadPDF()">üìÑ PDF</button>
    </div>
  </div>
</div>

<script>
let rows = [];
const TASKS = {
  terrassement: { d: "Terrassement g√©n√©ral en d√©blai", u: "m¬≥", p: 550 },
  fondations: { d: "B√©ton arm√© pour semelles (350kg/m¬≥)", u: "m¬≥", p: 16500 },
  assainissement: { d: "Pose canalisation PVC √ò200mm", u: "ml", p: 2800 },
  aep: { d: "Conduite PEHD √ò110mm PN16", u: "ml", p: 3200 },
  enrobe: { d: "Rev√™tement en b√©ton bitumineux √©p: 5cm", u: "m¬≤", p: 2100 },
  bordure: { d: "Fourniture et pose bordures type T2", u: "ml", p: 1850 }
};

function addRow(data = null) {
  const row = {
    id: Date.now() + Math.random(),
    desig: data ? data.d : "",
    unit: data ? data.u : "m¬≤",
    qty: "",
    pu: data ? data.p : ""
  };
  rows.push(row);
  render();
  saveProject();
}

function addQuick(key) { addRow(TASKS[key]); }

function render() {
  const body = document.getElementById('table-body');
  body.innerHTML = rows.map(r => `
    <tr>
      <td><input type="text" value="${r.desig}" oninput="update(${r.id}, 'desig', this.value)" placeholder="Nom de l'article..."></td>
      <td><input type="text" value="${r.unit}" oninput="update(${r.id}, 'unit', this.value)" style="width: 60px; text-align: center;"></td>
      <td><input type="number" value="${r.qty}" oninput="update(${r.id}, 'qty', this.value)" style="width: 80px; text-align: right;"></td>
      <td><input type="number" value="${r.pu}" oninput="update(${r.id}, 'pu', this.value)" style="width: 100px; text-align: right;"></td>
      <td style="text-align: right; font-weight: 700;">${fmt((r.qty||0)*(r.pu||0))}</td>
      <td><button onclick="remove(${r.id})" style="border:none; background:none; cursor:pointer; color:#cbd5e1;">‚úï</button></td>
    </tr>
  `).join('');
  recalc();
}

function update(id, field, val) {
  const r = rows.find(x => x.id === id);
  r[field] = val;
  if(field !== 'desig' && field !== 'unit') recalc();
  saveProject();
}

function remove(id) { rows = rows.filter(x => x.id !== id); render(); saveProject(); }

function recalc() {
  const ht = rows.reduce((s, r) => s + (r.qty * r.pu || 0), 0);
  const tvaRate = document.getElementById('tva-select').value;
  const tva = ht * (tvaRate / 100);
  document.getElementById('total-ht').innerText = fmt(ht) + " DZD";
  document.getElementById('total-tva').innerText = fmt(tva) + " DZD";
  document.getElementById('total-ttc').innerText = fmt(ht + tva) + " DZD";
  document.getElementById('tva-label').innerText = tvaRate;
}

function fmt(n) { return new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2 }).format(n); }

function saveProject() {
  localStorage.setItem('buildquant_data', JSON.stringify({
    rows,
    name: document.getElementById('proj-name').value,
    client: document.getElementById('proj-client').value
  }));
  document.getElementById('save-status').innerText = "Sauvegard√© ‚úì";
}

function loadProject() {
  const data = JSON.parse(localStorage.getItem('buildquant_data'));
  if(data) {
    rows = data.rows || [];
    document.getElementById('proj-name').value = data.name || "";
    document.getElementById('proj-client').value = data.client || "";
    render();
  }
}

function newProject() { if(confirm("Effacer tout ?")) { rows = []; localStorage.clear(); location.reload(); } }

async function downloadPDF() {
  const btn = document.getElementById('btn-pdf');
  btn.innerText = "‚è≥...";
  btn.disabled = true;
  
  const container = document.createElement('div');
  container.style.cssText = "padding:40px; background:white; color:black; font-family:Arial; width:800px; position:fixed; left:-9999px;";
  const ht = rows.reduce((s, r) => s + (r.qty * r.pu || 0), 0);
  const tva = ht * (document.getElementById('tva-select').value / 100);
  
  container.innerHTML = `
    <h1 style="color:#004AAD; border-bottom:2px solid #004AAD;">BuildQuant - Devis</h1>
    <p><strong>Projet:</strong> ${document.getElementById('proj-name').value}</p>
    <p><strong>Client:</strong> ${document.getElementById('proj-client').value}</p>
    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
      <tr style="background:#f1f5f9;">
        <th style="border:1px solid #ddd; padding:8px;">D√©signation</th>
        <th style="border:1px solid #ddd; padding:8px;">Qt√©</th>
        <th style="border:1px solid #ddd; padding:8px;">P.U</th>
        <th style="border:1px solid #ddd; padding:8px;">Total</th>
      </tr>
      ${rows.map(r => `
        <tr>
          <td style="border:1px solid #ddd; padding:8px;">${r.desig}</td>
          <td style="border:1px solid #ddd; padding:8px; text-align:center;">${r.qty}</td>
          <td style="border:1px solid #ddd; padding:8px; text-align:right;">${fmt(r.pu)}</td>
          <td style="border:1px solid #ddd; padding:8px; text-align:right; font-weight:bold;">${fmt(r.qty*r.pu)}</td>
        </tr>
      `).join('')}
    </table>
    <div style="margin-top:20px; text-align:right; font-size:16px;">
      <p>Total HT: <strong>${fmt(ht)} DZD</strong></p>
      <p>TVA: <strong>${fmt(tva)} DZD</strong></p>
      <p style="color:#004AAD; font-size:20px;">TOTAL TTC: <strong>${fmt(ht+tva)} DZD</strong></p>
    </div>
  `;
  
  document.body.appendChild(container);
  await new Promise(r => setTimeout(r, 1000));
  
  const opt = { margin:10, filename:'Devis_BuildQuant.pdf', html2canvas:{scale:2}, jsPDF:{unit:'mm', format:'a4'} };
  await html2pdf().set(opt).from(container).save();
  
  document.body.removeChild(container);
  btn.innerText = "üìÑ PDF";
  btn.disabled = false;
}

window.onload = loadProject;
</script>
</body>
</html>
